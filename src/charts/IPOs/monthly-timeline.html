<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biotech IPO Monthly Timeline</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Lato', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            padding: 24px;
        }
        
        .chart-container {
            background: transparent;
            max-width: 850px;  /* Updated to fit blog posts */
            margin: 0 auto;
            padding: 0;
        }
        
        .chart-title {
            font-size: 24px;
            font-weight: 700;
            color: #1c2b3a;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .chart-subtitle {
            font-size: 14px;
            font-weight: 400;
            color: #6c7680;
            text-align: center;
            margin-bottom: 32px;
        }
        
        .axis-label {
            font-size: 14px;
            font-weight: 400;
            color: #2c3e50;
            fill: #2c3e50;
        }
        
        .tick text {
            font-size: 12px;
            font-weight: 400;
            color: #6c7680;
            fill: #6c7680;
        }
        
        .grid-line {
            stroke: #f2f2f2;
            stroke-width: 1px;
        }
        
        .domain {
            stroke: #f2f2f2;
        }
        
        .tooltip {
            position: absolute;
            background: #1c2b3a;
            color: #FFFFFF;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 250ms ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .bar {
            transition: opacity 250ms ease;
        }
        
        .bar:hover {
            opacity: 0.8;
        }
        
        .legend {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 16px;
            font-size: 13px;
            color: #2c3e50;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
        }

        /* Responsive styles optimized for blog integration */
        @media (max-width: 768px) {
            .chart-title { 
                font-size: 20px; 
                margin-bottom: 6px;
            }
            .chart-subtitle { 
                font-size: 12px; 
                margin-bottom: 24px;
            }
            .axis-label { font-size: 12px; }
            .tick text { font-size: 10px; }
            body { padding: 16px; }
            .chart-container { 
                padding: 0; 
                max-width: 100%;
            }
            .legend {
                gap: 16px;
                font-size: 12px;
            }
        }

        @media (max-width: 600px) {
            .chart-title { font-size: 18px; }
            .chart-subtitle { font-size: 11px; }
            .legend {
                flex-direction: column;
                align-items: center;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="chart-container">
        <h1 class="chart-title">Biotech IPO Boom & Bust Cycle</h1>
        <p class="chart-subtitle">Monthly IPO count and total proceeds (April 2020 - March 2022)</p>
        <svg id="timeline-chart"></svg>
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #3a6d95;"></div>
                <span>IPO Count</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #5a9d83;"></div>
                <span>Total Proceeds ($M)</span>
            </div>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>

    <script>
        console.log('Script loaded successfully');
        
        async function loadFullData() {
            console.log('loadFullData called');
            try {
                console.log('About to fetch JSON');
                // Fetch data from JSON file
                const response = await fetch('/_data/biotech-ipos-compact.json');
                console.log('Fetch response received:', response.status);
                const rawData = await response.json();
                console.log('JSON parsed, total companies:', rawData.companies.length);
                
                // Group data by month and aggregate
                const monthlyGroups = {};
                
                rawData.companies.forEach(record => {
                    const date = new Date(record.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    
                    if (!monthlyGroups[monthKey]) {
                        monthlyGroups[monthKey] = {
                            count: 0,
                            totalProceeds: 0,
                            companies: []
                        };
                    }
                    
                    monthlyGroups[monthKey].count++;
                    monthlyGroups[monthKey].totalProceeds += record.proceeds;
                    monthlyGroups[monthKey].companies.push(record.name);
                });
                
                // Convert to array format expected by the chart
                const processedData = Object.entries(monthlyGroups).map(([month, data]) => ({
                    month,
                    date: new Date(month + "-01"),
                    count: data.count,
                    totalProceeds: data.totalProceeds,
                    companies: data.companies
                })).sort((a, b) => a.date - b.date);
                
                console.log('Data processed, months found:', processedData.length);
                return processedData;
                
            } catch (error) {
                console.error('Error loading data:', error);
                return [];
            }
        }

        async function createChart() {
            console.log('createChart called');
            
            try {
                console.log('About to call loadFullData');
                const data = await loadFullData();
                console.log('Data loaded:', data.length, 'months');
                
                if (data.length === 0) {
                    console.error('No data to display');
                    return;
                }
                
                // Updated responsive sizing for blog integration
                const margin = { top: 20, right: 70, bottom: 60, left: 60 };
                const containerElement = document.querySelector('.chart-container');
                const containerWidth = Math.min(850, containerElement.offsetWidth || window.innerWidth - 48);
                const width = containerWidth - margin.left - margin.right;
                const height = Math.min(400, width * 0.6); // Maintain aspect ratio, max height 400px

                // Clear any existing chart
                d3.select("#timeline-chart").selectAll("*").remove();

                const svg = d3.select("#timeline-chart")
                    .attr("width", containerWidth)  
                    .attr("height", height + margin.top + margin.bottom);

                const g = svg.append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                // Scales with padding to prevent bars from overlapping axes
                const xExtent = d3.extent(data, d => d.date);
                const timePadding = (xExtent[1] - xExtent[0]) * 0.05; // 5% padding on each side
                const xScale = d3.scaleTime()
                    .domain([
                        new Date(xExtent[0].getTime() - timePadding),
                        new Date(xExtent[1].getTime() + timePadding)
                    ])
                    .range([0, width]);

                const yScaleCount = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.count)])
                    .range([height, 0]);

                const yScaleProceeds = d3.scaleLinear()
                    .domain([0, d3.max(data, d => d.totalProceeds)])
                    .range([height, 0]);

                console.log('About to create chart elements');

                // Create grid lines
                g.selectAll(".grid-line-y")
                    .data(yScaleCount.ticks(5))
                    .enter()
                    .append("line")
                    .attr("class", "grid-line")
                    .attr("x1", 0)
                    .attr("x2", width)
                    .attr("y1", d => yScaleCount(d))
                    .attr("y2", d => yScaleCount(d));

                // Axes - responsive tick formatting
                const tickCount = width < 600 ? 4 : 6;
                const xAxis = d3.axisBottom(xScale)
                    .tickFormat(d3.timeFormat(width < 600 ? "%b '%y" : "%b %Y"))
                    .ticks(tickCount);

                const yAxisLeft = d3.axisLeft(yScaleCount)
                    .ticks(5);
                const yAxisRight = d3.axisRight(yScaleProceeds)
                    .ticks(5);

                g.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(xAxis)
                    .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", ".15em")
                    .attr("transform", "rotate(-35)");

                g.append("g")
                    .call(yAxisLeft);

                g.append("g")
                    .attr("transform", `translate(${width},0)`)
                    .call(yAxisRight);

                // Axis labels - responsive sizing
                const labelFontSize = width < 600 ? "12px" : "14px";
                
                g.append("text")
                    .attr("class", "axis-label")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 0 - margin.left)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "1em")
                    .style("text-anchor", "middle")
                    .style("font-size", labelFontSize)
                    .text("Number of IPOs");

                g.append("text")
                    .attr("class", "axis-label")
                    .attr("transform", "rotate(-90)")
                    .attr("y", width + margin.right - 10)
                    .attr("x", 0 - (height / 2))
                    .attr("dy", "-1em")
                    .style("text-anchor", "middle")
                    .style("font-size", labelFontSize)
                    .text("Total Proceeds ($M)");

                // Bars for IPO count - responsive bar width
                const barWidth = Math.max(width / data.length * 0.6, 8); // Minimum 8px width
                
                g.selectAll(".bar-count")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", d => xScale(d.date) - barWidth/2)
                    .attr("y", d => yScaleCount(d.count))
                    .attr("width", barWidth)
                    .attr("height", d => height - yScaleCount(d.count))
                    .attr("fill", "#3a6d95")
                    .attr("opacity", 0.8)
                    .on("mouseover", function(event, d) {
                        const tooltip = d3.select("#tooltip");
                        tooltip.style("opacity", 1)
                            .html(`
                                <strong>${d3.timeFormat("%B %Y")(d.date)}</strong><br/>
                                IPOs: ${d.count}<br/>
                                Total Proceeds: $${d.totalProceeds.toFixed(1)}M<br/>
                                Avg per IPO: $${(d.totalProceeds/d.count).toFixed(1)}M
                            `)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function() {
                        d3.select("#tooltip").style("opacity", 0);
                    });

                // Line for total proceeds
                const line = d3.line()
                    .x(d => xScale(d.date))
                    .y(d => yScaleProceeds(d.totalProceeds))
                    .curve(d3.curveMonotoneX);

                g.append("path")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", "#5a9d83")
                    .attr("stroke-width", 3)
                    .attr("d", line);

                // Points on the line - responsive dot size
                const dotRadius = width < 600 ? 3 : 4;
                
                g.selectAll(".dot")
                    .data(data)
                    .enter()
                    .append("circle")
                    .attr("class", "dot")
                    .attr("cx", d => xScale(d.date))
                    .attr("cy", d => yScaleProceeds(d.totalProceeds))
                    .attr("r", dotRadius)
                    .attr("fill", "#5a9d83")
                    .on("mouseover", function(event, d) {
                        const tooltip = d3.select("#tooltip");
                        tooltip.style("opacity", 1)
                            .html(`
                                <strong>${d3.timeFormat("%B %Y")(d.date)}</strong><br/>
                                IPOs: ${d.count}<br/>
                                Total Proceeds: $${d.totalProceeds.toFixed(1)}M<br/>
                                Avg per IPO: $${(d.totalProceeds/d.count).toFixed(1)}M
                            `)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", function() {
                        d3.select("#tooltip").style("opacity", 0);
                    });
                    
                console.log('Chart created successfully');
                
            } catch (error) {
                console.error('Error in createChart:', error);
            }
        }

        // Initialize chart with debugging
        console.log('Script loaded, about to call createChart');
        createChart();

        // Responsive resize with debouncing
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(createChart, 250);
        });
    </script>
</body>
</html>