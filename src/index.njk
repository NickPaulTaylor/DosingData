{# --- Front Matter --- #}
---
title: Dosing Data Blog # Or your actual site title
layout: base.njk # Uses _includes/base.njk
permalink: / # Generates index.html at the root
---

{# This extends the base layout. The content below goes into the 'content' block defined in base.njk #}
{% extends "base.njk" %}

{# Import your post card macro, path relative to _includes #}
{% import "macros/post-card.njk" as cards %}

{# Define the content that goes into the 'content' block of base.njk #}
{% block content %}

  {# --- START: Calculate Hero Posts --- #}

  {# Get all featured posts from the collection #}
  {% set featured = collections.featuredPosts %} {# Expect 5 items #}

  {# Find the center post using the reliable loop method #}
  {% set centerPost = null %}
  {% for post in featured %}
    {% if post.data.featured_center === true %}
        {% set centerPost = post %}
    {% endif %}
  {% endfor %}

  {# --- Calculate sidePosts Manually (Confirmed Working Method) --- #}
  {% set potentialSidePosts = [] %} {# Initialize empty array #}
  {% if centerPost %}
      {# Loop through original featured posts #}
      {% for post in featured %}
          {# Add post only if its URL doesn't match the center post's URL #}
          {% if post.url != centerPost.url %}
              {# Use working list concatenation method #}
              {% set potentialSidePosts = (potentialSidePosts.push(post), potentialSidePosts) %}
          {% endif %}
      {% endfor %}
  {% else %}
      {# If no center post, all featured posts are potential sides #}
      {% set potentialSidePosts = featured %}
  {% endif %}
  {# --- End Manual Calculation --- #}

  {# Take the first 4 remaining posts to be side posts (should be 4) #}
  {% set sidePosts = potentialSidePosts | slice(0, 4) %} {# Expect 4 items #}

  {# Split the final side posts into left (first 2) and right (next 2) groups #}
  {% set leftPosts = sidePosts | slice(0, 2) %}  {# Expect 2 items #}
  {% set rightPosts = sidePosts | slice(2, 4) %} {# Expect 2 items #}

  {# --- END: Calculate Hero Posts --- #}


  {# --- START: Render Hero Section (Original Grid Layout) --- #}
  {# Render the section only if there's content #}
  {% if centerPost or sidePosts.length > 0 %}
    <section class="hero-section">

      {# Left Side Column #}
      <div class="hero-side hero-left">
        {% for post in leftPosts %}
          {{ cards.postCard(post, 'small') }}
        {% endfor %}
      </div>

      {# Center Column Wrapper #}
      <div class="hero-center-wrapper">
        {% if centerPost %}
          {{ cards.postCard(centerPost, 'large') }}
        {% endif %}
      </div>

      {# Right Side Column #}
      <div class="hero-side hero-right">
        {% for post in rightPosts %}
          {{ cards.postCard(post, 'small') }}
        {% endfor %}
      </div>

    </section> {# End of hero-section #}

    {# Horizontal separator line below the hero section #}
    <hr class="hero-separator">

  {% endif %} {# End of condition to render hero section #}
  {# --- END: Render Hero Section --- #}


  {# --- START: Rest of the content (More Posts) --- #}
  <h2>More Posts</h2>
  <div class="post-grid">

    {# Build list of hero URLs #}
    {% set heroUrlsList = [] %}
    {% if centerPost %}
      {% set heroUrlsList = heroUrlsList + [centerPost.url] %}
    {% endif %}
    {# Use sidePosts which should now be correct (4 items) #}
    {% for post in sidePosts %}
       {# Use working list concatenation #}
      {% set heroUrlsList = heroUrlsList + [post.url] %}
    {% endfor %}

    {# Loop through ALL posts #}
    {% for post in collections.posts %}
      {% if post.url not in heroUrlsList %}

        {# Render post preview #}
        <article class="post-preview">
           <a href="{{ post.url | url }}" class="post-preview__link">
             {% if post.data.featuredImage %}
             <div class="post-preview__image-container">
               <img src="{{ post.data.featuredImage | url }}" alt="" class="post-preview__image">
             </div>
             {% endif %}
             <div class="post-preview__content">
               <h3 class="post-preview__title">{{ post.data.title }}</h3>
               {% if post.data.excerpt %}
               <p class="post-preview__excerpt">{{ post.data.excerpt }}</p>
               {% endif %}
               {# Date filter still needs fixing separately #}
               <time datetime="{{ post.date | htmlDateString }}" class="post-preview__date">{{ post.date | readableDate }}</time>
             </div>
           </a>
         </article>

      {% endif %}
    {% endfor %}

  </div> {# End of post-grid #}
  {# --- END: Rest of the content --- #}

{% endblock %}