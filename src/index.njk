{# --- Front Matter --- #}
---
title: Dosing Data Blog # Or your actual site title
layout: base.njk # Uses _includes/base.njk
permalink: / # Generates index.html at the root
---

{# This extends the base layout. The content below goes into the 'content' block defined in base.njk #}
{% extends "base.njk" %}

{# Import your post card macro, path relative to _includes #}
{% import "macros/post-card.njk" as cards %}

{# Define the content that goes into the 'content' block of base.njk #}
{% block content %}

  {# --- START: Calculate Hero Posts --- #}

  {# Get all featured posts from the collection #}
  {% set featured = collections.featuredPosts %} {# Expect 5 items #}

  {# Find the center post using the reliable loop method #}
  {% set centerPost = null %}
  {% for post in featured %}
    {% if post.data.featured_center === true %}
        {% set centerPost = post %}
    {% endif %}
  {% endfor %}

  {# --- Calculate sidePosts Manually (Confirmed Working Method) --- #}
  {% set potentialSidePosts = [] %}
  {% if centerPost %}
      {% for post in featured %}
          {% if post.url != centerPost.url %}
              {% set potentialSidePosts = (potentialSidePosts.push(post), potentialSidePosts) %}
          {% endif %}
      {% endfor %}
  {% else %}
      {% set potentialSidePosts = featured %}
  {% endif %}
  {# Set sidePosts - we know this now contains 4 iterable items #}
  {% set sidePosts = potentialSidePosts | slice(0, 4) %} {# Keep slice limit just in case initial list > 4 #}

  {# --- Manually Split sidePosts into leftPosts and rightPosts (Avoid Slice Filter) --- #}
  {% set leftPosts = [] %}
  {% set rightPosts = [] %}
  {% for post in sidePosts %}
      {# loop.index is 1-based #}
      {% if loop.index <= 2 %} {# First 2 items go to leftPosts #}
          {% set leftPosts = leftPosts + [post] %}
      {% elif loop.index <= 4 %} {# Items 3 and 4 go to rightPosts #}
          {% set rightPosts = rightPosts + [post] %}
      {% endif %}
  {% endfor %}
  {# --- End Manual Split --- #}

  {# --- END: Calculate Hero Posts --- #}


  {# --- START MINIMAL COUNT DEBUG (Optional - Keep or Remove) --- #}
  {# You can keep this line temporarily to verify the final counts #}
  <div style="border: 1px solid teal; background-color: #eff; padding: 5px; margin: 10px 0; font-family: monospace; color: teal;">
     DEBUG COUNTS :: side={{ sidePosts | length }} | left={{ leftPosts | length }} | right={{ rightPosts | length }}
  </div>
  {# --- END MINIMAL COUNT DEBUG --- #}


  {# --- START: Render Hero Section (Original Grid Layout) --- #}
  {# Render the section only if there's content #}
  {% if centerPost or sidePosts.length > 0 %}
    <section class="hero-section">

      {# Left Side Column #}
      <div class="hero-side hero-left">
        {% for post in leftPosts %} {# Should now loop 2 times #}
          {{ cards.postCard(post, 'small') }}
        {% endfor %}
      </div>

      {# Center Column Wrapper #}
      <div class="hero-center-wrapper">
        {% if centerPost %}
          {{ cards.postCard(centerPost, 'large') }}
        {% endif %}
      </div>

      {# Right Side Column #}
      <div class="hero-side hero-right">
        {% for post in rightPosts %} {# Should now loop 2 times #}
          {{ cards.postCard(post, 'small') }}
        {% endfor %}
      </div>

    </section> {# End of hero-section #}

    {# Horizontal separator line below the hero section #}
    <hr class="hero-separator">

  {% endif %} {# End of condition to render hero section #}
  {# --- END: Render Hero Section --- #}


  {# --- START: Rest of the content (More Posts) --- #}
  <h2>More Posts</h2>
  <div class="post-grid">

    {# Build list of hero URLs #}
    {% set heroUrlsList = [] %}
    {% if centerPost %}
      {% set heroUrlsList = heroUrlsList + [centerPost.url] %}
    {% endif %}
    {# Use sidePosts which should now be correct (4 items) #}
    {% for post in sidePosts %}
       {% set heroUrlsList = heroUrlsList + [post.url] %}
    {% endfor %}

    {# Loop through ALL posts #}
    {% for post in collections.posts %}
      {% if post.url not in heroUrlsList %}
        {# Render post preview #}
        <article class="post-preview">
           <a href="{{ post.url | url }}" class="post-preview__link">
             {% if post.data.featuredImage %}
             <div class="post-preview__image-container">
               <img src="{{ post.data.featuredImage | url }}" alt="" class="post-preview__image">
             </div>
             {% endif %}
             <div class="post-preview__content">
               <h3 class="post-preview__title">{{ post.data.title }}</h3>
               {% if post.data.excerpt %}
               <p class="post-preview__excerpt">{{ post.data.excerpt }}</p>
               {% endif %}
               {# Date filter still needs fixing separately #}
               <time datetime="{{ post.date | htmlDateString }}" class="post-preview__date">{{ post.date | readableDate }}</time>
             </div>
           </a>
         </article>
      {% endif %}
    {% endfor %}

  </div> {# End of post-grid #}
  {# --- END: Rest of the content --- #}

{% endblock %}